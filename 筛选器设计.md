好的，我先把你这份 GRAMPA 合并表的“秉性”吃透，然后给出一套**贴合数据特点**的 MIC 筛选器方案（含清洗、建模、损失函数、评估与筛选策略）。下面的数字都来自你上传的数据实测。

---

# 一、这份数据的“性格”

* 样本量：**44,797** 行，字段：`bacterium / sequence / unit / value / censor / database`
* 单位：**全部是 uM**（已统一）。
* 标签：`value` 已是 **log10(μM)**。分布：P50≈0.099，P5≈−0.634，P95≈1.243，极端值范围约 **\[−3.56, 3.66]**（存在少量异常极端）。
* 删失：`censor` 仅见 **“>” 865 条（≈2%）**，其余为空。表示“MIC 大于某阈值”（右删失）。
* 菌株：去重 **1,268** 个名称，长尾明显；Top 20 占大多数（E. coli、S. aureus、P. aeruginosa…）。
* 序列：去重 **7,499** 条；**每条序列平均有 6 次测定**（中位 4，最多 48），即同一肽对多个菌株/重复实验。
* 长度：Q2=18，Q3=25；**5–48 aa 占 42,840 条**（建议主训练集），<5 aa 有 680 条，>48 aa 有 1,277 条。
* 字母表：约 **1.6%** 的序列含非标准字符（如 X、B、Z、J、U、O、以及个别小写/空格/标点等），需要清洗。
* 同（sequence, bacterium）**重复测定**普遍（最多 5 次），重复间 **std** 有高有低，存在测量噪声/批次差异。

> 启示：这是一个\*\*“序列 × 菌株 → 连续 logMIC”\*\* 的回归问题，且高度不平衡、少量右删失、存在重复测量与异常值。需要**分两层视角**：
> （1）**序列总体活性**（聚合后 \~7k）；（2）**按菌株的细粒度活性**（原始 \~45k）。

---

# 二、数据清洗与标准化（强烈建议）

1. **序列合法化**

* 统一 `A–Z` 大写；将 `{B,Z,J}`（模糊残基）与任何非 20 标准氨基酸字符映射为 `X`；若 `X` 占比 >10% 则丢弃该样本（避免劣质标签污染）。
* 限定主训练集为 **5–48 aa**（42,840 条），与后续生成模型长度上限一致；<5 与 >48 可单独留作外推评估。

2. **菌株归一化**

* 统一物种名与常见缩写：如 `Escherichia coli` / `E. coli` → `escherichia_coli`；`Staph. aureus` → `staphylococcus_aureus` 等。
* 只保留“物种”维度（去掉株系/毒力型后缀），长尾**频次很低的菌株**可聚合为 `other`（或仅在“条件回归”中用共享 embedding 表征）。

3. **重复测定处理**

* 对同一 **(sequence, bacterium)** 的多个测定：训练时默认**几何均值**（= 对原始 μM 取 gmean，再 log10），同时保留**重复条数 n** 作为样本权重或不确定性参考。
* 可选：用“**分布学习**”——预测均值 μ 与方差 σ²（见后文损失），让模型吸收实验噪声而非强行平均。

4. **删失样本（censor=“>”）**

* 解释：这是**右删失**（`true_logMIC > value`）。
* 标注为区间标签：`y ∈ (value, +∞)`，进入**删失感知损失**（见后文）。占比小，可以加权放大其约束。

5. **异常值稳健化**

* 对 `value` 进行**winsorize**（建议按 1%–99% 分位）：把 \<P1 拉到 P1，把 >P99 拉到 P99（例如 \~\[−1.13, 2.06]），或使用 **Huber**/分位数损失避免被极端点牵引。

6. **划分策略（防信息泄漏）**

* **GroupKFold by `sequence`**：保证同一条序列不会同时出现在 train 与 val/test（即便是不同菌株）。
* 验证集内做**菌株比例对齐**（StratifiedGroupKFold 近似实现或分层抽样），避免验证集被头部物种主导。

---

# 三、特征构建（轻重皆可）

* **PLM 表征**（推荐）：

  * ESM-2（650M）→ **per-residue** embedding；
  * **池化**成定长向量（均值池化 + 最大池化 → 2×D）；
  * 可追加 **LayerNorm** 与 **PCA/随机投影** 将维数压到 512–1024，便于 MLP 训练。
* **理化特征**：长度、净电荷（pH=7.4）、等电点、GRAVY、氨基酸 20 维比例、RK 含量、疏水矩（螺旋假设）等。
* **菌株表示**（针对完整聚合数据集，序列聚合的数据集没有）：

  * Learned embedding（维度 16–64）或 one-hot。对 `other` 共享一个 embedding。

---

# 四、两层建模方案（互补使用）

## A. **序列聚合回归**（\~7k，给“总体活性”打分）

* **输入**：序列 embedding（+理化特征）。
* **模型**：2–3 层 MLP（宽度 512–1024，ReLU/SiLU，Dropout 0.2–0.5，WD=1e-4）。
* **损失**：Huber/MSE（对 winsorized 的 logMIC）。
* **输出**：\$\hat y=\widehat{\log\_{10}(\text{MIC}\_\mu\text{M})}\$。
* **用途**：快速判定“强/弱活性”；给生成肽做第一道阈值过滤。

## B. **条件回归（序列 × 菌株）**（\~45k，能看广谱）

* **输入**：`[seq_embedding ⊕ bacterium_embedding ⊕ features]`
* **模型**：统一的 **单头回归器**（推荐）
* **损失（关键）**：**删失感知 + 稳健回归**

  * 非删失：Huber / 高斯 NLL（若模型同时输出 σ）。
  * 右删失样本：
    * **简单版（hinge）**：\$L\_{>}= \lambda\cdot\max(0,, y\_{\text{th}}-\hat y)^2\$；
    * 实践建议：先用简单 hinge（实现快、稳定）
  * **长尾菌株重权**：物种权重 \$w\_i=1/\sqrt{N\_i}\$，或 WeightedRandomSampler。
* **输出**：\$\hat y\_{(seq,,bact)}\$，可进一步计算**广谱分数**（见筛选）。

---

# 五、训练细节（落地可复现）

* **切分**：GroupKFold(5) 按序列，保头部菌株比例。
* **优化**：AdamW（lr=2e-4，WD=1e-4），Cosine/ReduceLROnPlateau，Early-Stopping(patience=10)。
* **正则**：Dropout 0.3±0.1，LayerNorm，Gradient Clip=1.0。
* **批量**：64–256（看显存）；混合精度可开。
* **监控指标**：

  * 主：RMSE、\$R^2\$（整体 & 分菌株加权平均）。
  * 派生二分类（阈值见下）：AUROC、AUPRC、F1。
* **消融**：只用 PLM vs +理化；是否 winsorize；是否删失感知；是否菌株 embedding；对 Top-K 菌株单独评估。

---

# 六、推理与“可落地”的筛选策略

把两层模型**级联**，更稳：

1. **先用 A（序列聚合）**

   * 阈值换算：

     * 10 μM ↔ **logMIC = 1**
     * 5 μM ↔ **logMIC ≈ 0.699**
     * 2 μM ↔ **logMIC ≈ 0.301**
   * 经验门槛：先取 **\$\hat y \le 1.0\$**（≤10 μM）作为**候选**，\$\hat y \le 0.7\$（≤5 μM）作为**强候选**。

2. **再用 B（条件回归）看广谱**

   * 选一组代表菌株（例如：`E. coli`, `S. aureus`, `P. aeruginosa`, `K. pneumoniae`, `C. albicans`）。
   * 计算：

     * **broad\_score = 均值**$(\hat y_{\text{这些菌株}})$（越小越好）；
     * **hit\_rate\@10μM = 平均 I{\hat y \le 1}**；
     * **worst\_case = 最大 $\hat y$**（最差菌株也不太差）。
   * 排序规则示例：`强候选优先，按 (hit_rate 降序, broad_score 升序, worst_case 升序) 排`。
   * 同时输出**不确定性**（若训练了 σ 或用 MC-Dropout），给实验同学做风险评估。



# 七、你这个数据集的“专属注意事项”

* **长度外推**：>48 aa 的 1,277 条不建议与 ≤48 混训（分布差异 & 与生成模型不匹配）。可单独训练一个“长肽版”或只做外推评估。
* **非标准残基**：将非 20AA 全部转 `X` 后，**统计 X 占比**，>10% 直接剔除；否则会给 PLM 带来不稳定的 token 噪声。
* **重复测定**：与其简单平均，不如**学习方差**（预测 σ），或在 DataLoader 里对重复多的对（sequence, bacterium）**减权**，避免“测得多=权重大”。
* **菌株长尾**：Top 20/30 建立“已知菌株 embedding”，其余聚为 `other`；或用层级 taxonomy（属/科）embedding 提升泛化。
* **删失极少但很重要**：右删失（>）往往来自“抑菌无效”，它对**减少过拟合乐观**很关键；建议至少用 **hinge 约束**。


# 九、一步到位的训练顺序（你可以直接照做）

1. 规范化菌株名 & 过滤 5–48 aa & 序列合法化（`X` 占比阈值）
2. 对 (seq,bact) 重复做几何均值；构建 **A 集（聚合到序列）** 与 **B 集（保留菌株）**
3. 生成 ESM embedding（residue→pooling）并缓存
4. 训练 **模型 A**（序列聚合回归）：5 折 GroupKFold，调 Dropout、宽度、是否 winsorize
5. 训练 **模型 B**（条件回归）：加菌株 embedding、权重采样、删失 hinge 损失
6. 统一验证：整体 & 分菌株 RMSE / R²；二分类 AUROC@{2,5,10 μM}
7. 部署筛选脚本：两阶段阈值 + 广谱打分；输出候选清单
8. 误差剖面：对长度/电荷/菌株做偏差分析，必要时做 **per-species 校准**（Platt/Isotonic）
9. 选 Top-N 做**体外实验**；回流新数据做持续学习
10. 与溶血/毒性模型、理化规则**串联**，形成完整筛选流水线
